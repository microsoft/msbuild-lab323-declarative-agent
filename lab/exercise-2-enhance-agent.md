# Exercise 2:  Enhance Agent capabilities

Next, you will enhance the agent by adding more operations, enabling responses with Adaptive Cards, and incorporating code interpreter capabilities. Let’s explore each of these enhancements step by step. Go back to the project in VS Code.

## Step 1: Modify agent to add more operations

- Go to file `actions.tsp` and copy paste below snippet just after `listRepairs` operation to add these new operations createRepair, updateRepair and deleteRepair. Here you are also defining the Repair item data model.

```typespec
/**
   * Create a new repair. 
   * When creating a repair, the `id` field is optional and will be generated by the server.
   * The `date` field should be in ISO 8601 format (e.g., "2023-10-01T12:00:00Z").
   * The `image` field should be a valid URL pointing to the image associated with the repair.
   * @param repair The repair to create.
   */
  @route("/repairs")  
  @post  op createRepair(@body repair: Repair): Repair;

  /**
   * Update an existing repair.
   * The `id` field is required to identify the repair to update.
   * The `date` field should be in ISO 8601 format (e.g., "2023-10-01T12:00:00Z").
   * The `image` field should be a valid URL pointing to the image associated with the repair.
   * @param repair The repair to update.
   */
  @route("/repairs")  
  @patch  op updateRepair(@body repair: Repair): Repair;

  /**
   * Delete a repair.
   * The `id` field is required to identify the repair to delete.
   * @param repair The repair to delete.
   */
  @route("/repairs") 
  @delete  op deleteRepair(@body repair: Repair): Repair;
  
  /**
   * A model representing a repair.
   */
  model Repair {
    /**
     * The unique identifier for the repair.
     */
    id?: string;

    /**
     * The short summary or title of the repair.
     */
    title: string;

    /**
     * The detailed description of the repair.
     */
    description?: string;

    /**
     * The user who is assigned to the repair.
     */
    assignedTo?: string;

    /**
     * The optional date and time when the repair is scheduled or completed.
     */
    @format("date-time")
    date?: string;

    /**
     * The URL of the image associated with the repair.
     */
    @format("uri")
    image?: string;
  }

```


- Next, go back to `main.tsp` file and make sure these new operations are also added into the agent's action. Paste the below snippet after the line `op listRepairs is global.RepairsAPI.listRepairs;` inside the `RepairServiceActions` namespace

```typespec
op createRepair is global.RepairsAPI.createRepair;
op updateRepair is global.RepairsAPI.updateRepair;
op deleteRepair is global.RepairsAPI.deleteRepair;   

```
- Also add a new conversation starter for creating a new repair item just after the first conversation start definintion.

```typespec
@conversationStarter(#{
  title: "Create repair",
  text: "Create a new repair titled \"[TO_REPLACE]\" and assign it to me"
})

```
## Step 2: Add adaptive card to function reference

Next, you will enhance the reference cards or response cards using adaptive cards. Let’s take the listRepairs operation and add an adaptive card for the repair item. 

- In the project folder, create a new folder called "cards" under the "appPackage" folder. Create a file `repair.json` in the cards folder and paste the code snippet as is from below to the file. 

```json
{
    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
    "type": "AdaptiveCard",
    "version": "1.5",
    "body": [
  {
    "type": "Container",
    "$data": "${$root}",
    "items": [
      {
        "type": "TextBlock",
        "text": "Title: ${if(title, title, 'N/A')}",
        "weight": "Bolder",
        "wrap": true
      },
      {
        "type": "TextBlock",
        "text": "Description: ${if(description, description, 'N/A')}",
        "wrap": true
      },
      {
        "type": "TextBlock",
        "text": "Assigned To: ${if(assignedTo, assignedTo, 'N/A')}",
        "wrap": true
      },
      {
        "type": "TextBlock",
        "text": "Date: ${if(date, date, 'N/A')}",
        "wrap": true
      },
      {
        "type": "Image",
        "url": "${image}",
        "$when": "${image != null}"
      }
    ]
  }
],  
    "actions": [
      {
        "type": "Action.OpenUrl",
        "title": "View Image",
        "url": "https://www.howmuchisit.org/wp-content/uploads/2011/01/oil-change.jpg"
      }
    ]
  }
  

```

- Next, go back to `actions.tsp` file and locate the listRepairs operation. Just above the operation definition `@get  op listRepairs(@query assignedTo?: string): string;`, paste the card definition using below snippet.

```typespec

  @card( #{ dataPath: "$",  title: "$.title",   url: "$.image", file: "cards/repair.json"}) 
  
  ```

The above card response will be sent by the agent when you ask about a repair item or when agent brings a list of items as its reference.
Continue to add card response for the `createRepair` operation to show what the agent created after the POST operation. 

- Copy paste below snippet just above the code `@post  op createRepair(@body repair: Repair): Repair;`

```typespec

   @card( #{ dataPath: "$",  title: "$.title",   url: "$.image", file: "cards/repair.json"}) 

```

## Step 3:   Add code interpreter capabilities

Declarative Agents can be extended to have many capabilities like OneDriveAndSharePoint, WebSearch, CodeInterpreter etc
Next, you will enhance the agent by adding code interpreter capability to it.

- To do this, open the `main.tsp` file and locate the `RepairServiceAgent` namespace.

- Within this namespace, insert the following snippet to define a new operation that enables the agent to interpret and execute code.

```typespec
  op codeInterpreter is AgentCapabilities.CodeInterpreter;
```


>[!TIP]
> When you add above codeinterpreter operation, paste it inside the outer `RepairServiceAgent` namespace and not the `RepairServiceActions` namespace which defines the action of the agent.  

Since the agent now supports additional functionality, update the instructions accordingly to reflect this enhancement.

- In the same `main.tsp` file, update instructions definition to have additional directives for the agent.

```typespec
@instructions("""
  ## Purpose
You will assist the user in finding car repair records based on the information provided by the user. When asked to display a report, you will use the code interpreter to generate a report based on the data you have.

  ## Guidelines
- You are a repair service agent.
- You can use the code interpreter to generate reports based on the data you have.
- You can use the actions to create, update, and delete repairs.
- When creating a repair item, if the user did not provide a description or date , use title as description and put todays date in format YYYY-MM-DD
- Do not show any code or technical details to the user. 
- Do not use any technical jargon or complex terms.

""")

```

## Step 4:  Provision and Test the Agent's

Let’s take the updated agent who is also now a repairs analyst to test. 

- Select the agents toolkit's extension icon to open its activity bar from within your project.
- In the activity bar of the toolkit under "LifeCycle" select "Provision" to package and upload the newly updated agent for testing. 
- Next, go back to the open Microsoft Edge browser tab and do a refresh. 
- Select the **RepairServiceAgent** from the right side of the screen under **Agents**.

- Start by using the conversation starter 'Create repair'. Replace parts of the prompt to add a title , then send it to the chat to initiate the interaction. For e.g.

    `Create a new repair titled "rear camera issue" and assign it to me.`

- The confirmation dialog if you notice has more metadata that what you sent, thanks to the new instructions. 

![new-confirmation](https://github.com/user-attachments/assets/56629979-b1e5-4a03-a413-0bb8bb438f00)
 
 - Proceed to add the item by confirming the dialog.

 The agent responds is with created item shown in a rich adaptive card.

 ![create-repair-ac](https://github.com/user-attachments/assets/6da0a38f-5de3-485a-999e-c695389853f8)


 - Next, recheck reference cards work. Send below prompt in the conversation

     `List all my repairs.`

The agent with the list with each referenced with an adaptive card.

![list-repairs](https://github.com/user-attachments/assets/880ad3aa-2ed3-4051-a68b-d988527d9d53)


- Next, you will test the new analytical capability of your agent. Open a new chat by selecting the **New chat** button on the top right corner of your agent.
- Next, copy the prompt below and paste it to the message box and hit enter to send it.

    `Classify repair items based on title into three distinct categories: Routine Maintenance, Critical, and Low Priority. Then, generate a pie chart displaying the percentage representation of each category. Use unique colours for each group and incorporate tooltips to show the precise values for each segment.`

You should get some response similar to below screen. It may vary sometimes. 

![final-chart](https://github.com/user-attachments/assets/ea1a5b21-bc57-4ed8-a8a4-c187caff2c64)


☑️ You've successfully completed the second exercise! Select **Next >** to go to the next exercise.
