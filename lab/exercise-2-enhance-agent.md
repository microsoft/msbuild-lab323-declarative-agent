# Exercise 2:  Enhance Agent capabilities

Next, we‚Äôll enhance this agent by adding more operations, enabling responses with Adaptive Cards, and incorporating code interpreter capabilities. Let‚Äôs explore each of these enhancements step by step.

## Step 1: Modify agent to add more operations

- Go to file actions.tsp and copy paste below snippet just after listRepairs operation to add the new operations.

```typespec
/**
   * Create a new repair. 
   * When creating a repair, the `id` field is optional and will be generated by the server.
   * The `date` field should be in ISO 8601 format (e.g., "2023-10-01T12:00:00Z").
   * The `image` field should be a valid URL pointing to the image associated with the repair.
   * @param repair The repair to create.
   */
  @route("/repairs")  
  @post  op createRepair(@body repair: Repair): Repair;

  /**
   * Update an existing repair.
   * The `id` field is required to identify the repair to update.
   * The `date` field should be in ISO 8601 format (e.g., "2023-10-01T12:00:00Z").
   * The `image` field should be a valid URL pointing to the image associated with the repair.
   * @param repair The repair to update.
   */
  @route("/repairs")  
  @patch  op updateRepair(@body repair: Repair): Repair;

  /**
   * Delete a repair.
   * The `id` field is required to identify the repair to delete.
   * @param repair The repair to delete.
   */
  @route("/repairs") 
  @delete  op deleteRepair(@body repair: Repair): Repair;
  
  /**
   * A model representing a repair.
   */
  model Repair {
    /**
     * The unique identifier for the repair.
     */
    id?: string;

    /**
     * The short summary or title of the repair.
     */
    title: string;

    /**
     * The detailed description of the repair.
     */
    description?: string;

    /**
     * The user who is assigned to the repair.
     */
    assignedTo?: string;

    /**
     * The optional date and time when the repair is scheduled or completed.
     */
    @format("date-time")
    date?: string;

    /**
     * The URL of the image associated with the repair.
     */
    @format("uri")
    image?: string;
  }

```
We have defined the new operations as well as the data model for a repair item. 

Let‚Äôs go back to main.tsp file and make sure these new operations are also added into the agent's action.
Paste the below snippet after *op listRepairs is global.RepairsAPI.listRepairs;* inside the "RepairServiceActions" namespace

```typespec
op createRepair is global.RepairsAPI.createRepair;
op updateRepair is global.RepairsAPI.updateRepair;
op deleteRepair is global.RepairsAPI.deleteRepair;   

```
Let‚Äôs also add a new conversation starter for creating a new repair item

```typespec
@conversationStarter(#{
  title: "Create repair",
  text: "Create a new repair titled \"[TO_REPLACE]\" and assign it to me"
})

```
## Step 2: Add adaptive card to function reference

Next, we‚Äôll show you how to enhance the reference or response cards using adaptive cards. Let‚Äôs take the listRepairs operation and add an adaptive card for the repair item. 
In the project folder, create a new folder called ‚Äúcards‚Äù under the ‚ÄúappPackage‚Äù folder. Create a file repair.json and paste the code snippet as is from below to the file. 

```typespec
{
    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
    "type": "AdaptiveCard",
    "version": "1.5",
    "body": [
  {
    "type": "Container",
    "$data": "${$root}",
    "items": [
      {
        "type": "TextBlock",
        "text": "Title: ${if(title, title, 'N/A')}",
        "weight": "Bolder",
        "wrap": true
      },
      {
        "type": "TextBlock",
        "text": "Description: ${if(description, description, 'N/A')}",
        "wrap": true
      },
      {
        "type": "TextBlock",
        "text": "Assigned To: ${if(assignedTo, assignedTo, 'N/A')}",
        "wrap": true
      },
      {
        "type": "TextBlock",
        "text": "Date: ${if(date, date, 'N/A')}",
        "wrap": true
      },
      {
        "type": "Image",
        "url": "${image}",
        "$when": "${image != null}"
      }
    ]
  }
],  
    "actions": [
      {
        "type": "Action.OpenUrl",
        "title": "View Image",
        "url": "https://www.howmuchisit.org/wp-content/uploads/2011/01/oil-change.jpg"
      }
    ]
  }
  

```

Next, go back to actions.tsp file and locate the listRepairs operation.
Just above the operation definition *@get  op listRepairs(@query assignedTo?: string): string;*, paste the card definition using below snippet.

```typespec
  @card( #{ dataPath: "$",  title: "$.title",   url: "$.image", file: "cards/repair.json"}) 
```

The card response is sent by the agent when you ask about a repair item or when agent brings a list of items as its reference.
Add a response card for the createRepair operation to show what the agent created. Copy paste below snippet just above the operation for create repair.

```typespec
  @capabilities(#{
    responseSemantics: #{
      dataPath: "$",
      properties: #{
        title: "$.title",
        subTitle: "$.description"      
      },
      staticTemplate: #{
        $schema: "http://adaptivecards.io/schemas/adaptive-card.json",
        type: "AdaptiveCard",
        version: "1.5",
      body: #[
        #{
        type: "TextBlock",
      text: "üéâ \${if(title, title, 'N/A')} successfully added and assigned to \${if(assignedTo, assignedTo, 'N/A')} ", 
      wrap: true,
      weight: "Bolder",     
      size: "Large"
        }      
      ] } }
     })

```

## Step 3:   Add code interpreter capabilities

Next, enhance the agent by adding code interpreter capabilities. To do this, open the main.tsp file and locate the RepairServiceAgent namespace. Within this namespace, insert the following snippet to define a new operation that enables the agent to interpret and execute code.

```typespec
  op codeInterpreter is AgentCapabilities.CodeInterpreter;
```
There are many other capabilities as well that can be added like OneDriveAndSharePoint, WebSearch etc. but for now let‚Äôs jus add CodeInterpreter.

Since the agent now supports report generation, update the instructions accordingly to reflect this new capability.
In the same main.tsp file, update instructions definition to have additional directives for the agent.

```typespec
@instructions("""
  ## Purpose
You will assist the user in finding car repair records based on the information provided by the user. When asked to display a report, you will use the code interpreter to generate a report based on the data you have.

  ## Guidelines
- You are a repair service agent.
- You can use the code interpreter to generate reports based on the data you have.
- You can use the actions to create, update, and delete repairs.
- Do not show any code or technical details to the user. 
- Do not use any technical jargon or complex terms.

""")

```

## Step 4:  Provision and Test the Agent's

Let‚Äôs take the updated agent who is also now a repairs analyst to test. 

- Select the Agent Toolkit extension to open its activity bar from within your project.
- In the activity bar of the toolkit under ‚ÄúLifeCycle‚Äù select ‚ÄúProvision‚Äù to package and upload the newly updated agent for testing. 
- Next, go to https://office.com/chat to open Copilot app and select the **RepairServiceAgent** from the right side of the screen under **Agents**.

- Start by using the conversation starter 'Create repair'. Add a title to the prompt, then send it to the chat to initiate the interaction. 

 +++*Create a new repair titled "New brake issue" and assign it to me.*+++ 
  
- You will get a confirmation dialog, proceed to confirm. The agent will add the item and send the response adaptive card back to you. 
  
- Next, send the prompt below to recheck if item is added. 

 +++*List all my repairs.*+++

You'll notice that the newly created item lacks both a description and a date. Let‚Äôs address this using the AI stack integrated with Copilot.

Insert the following code above the createRepair operation to apply a special instruction: set today‚Äôs date as the default value and use the title as the default description for this operation only. 


```typespec
  @state(orchestratorState.reasoning, 
      #{
        instructions: """
         When creating a repair item, if the user did not provide a description or date , use title as description and put todays date in format YYYY-MM-DD
        """
      })
```
Let's create another item. 

 +++*Create a new repair titled "rear camera issue" and assign it to me.*+++ 

 Proceed to add the item by confirming the dialog. Again recheck if item is added with description and date.

  +++*List all my repairs.*+++


- Next, copy the prompt below to test the new new agent with new analytical capability with your data. 

 +++*Classify repair items based on title into three distinct categories: Routine Maintenance, Critical, and Low Priority. Then, generate a pie chart displaying the percentage representation of each category. Use unique colours for each group and incorporate tooltips to show the precise values for each segment.*+++
